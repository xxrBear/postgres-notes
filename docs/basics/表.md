# 表

## 表基础

前面已经介绍了 PostgreSQL 的表是什么，对于我们来说，大部分的操作都是对表进行的，这一章节，我们先来简单介绍表的一些基础知识:

**创建表**
```sql
CREATE TABLE products (
    product_no integer,
    name text,
    price numeric
);
```

- 创建表需要使用命令`CREATE TABLE`在此命令中，至少要指定新表的名称、列的名称以及每列的数据类型

**删除表**

```sql
DROP TABLE products;
```
- 你也可以使用命令 `DROP TABLE IF EXISTS products` 防止表不存在的报错

## 默认值

可以为列分配默认值。当创建新行且未为某些列指定值时，这些列将填充其各自的默认值。数据操作命令也可以显式请求将列设置为其默认值，而无需知道该值是什么。

```sql
CREATE TABLE products (
    product_no integer,
    name text,
    price numeric DEFAULT 9.99
);
```

- 这会为`price`字段设置一个默认值`9.99`

默认值可以是一个表达式，该表达式将在每次插入默认值时进行评估（不是在创建表时）。一个常见的例子是`timestamp`字段的默认值为`CURRENT_TIMESTAMP`

## 标识列

在 PostgreSQL 里，标识列是一种自增列，用来自动生成唯一的数值，常用于主键定义中。它是 PostgreSQL 10 引入的，算是对早期 `serial` 伪类型的改进。

**使用 `GENERATED ... AS IDENTITY`**

```sql
CREATE TABLE users (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    name TEXT
);
```

* `GENERATED ALWAYS AS IDENTITY`
  系统总是生成值，如果你手动插入 `id`，会报错

* `GENERATED BY DEFAULT AS IDENTITY`
  系统默认生成值，但你也可以手动插入

**重置标识列**

```sql
ALTER TABLE users ALTER COLUMN id RESTART WITH 1;
```

## 系统列

在 PostgreSQL 中，每个表除了用户定义的列之外，还有一些系统列，这些列由数据库自动维护，不需要用户显式创建，主要用于内部管理和查询优化。

| 系统列名   | 含义            | 说明                                                            |
| ---------- | --------------- | --------------------------------------------------------------- |
| `ctid`     | 行标识          | 表中每一行的物理位置 `(页号, 行号)`，可用于快速定位或删除特定行 |
| `oid`      | 对象 ID         | 仅在包含 `WITH OIDS` 的表中存在，每行都有唯一对象标识           |
| `xmin`     | 插入事务号      | 行创建时对应的事务 ID，用于 MVCC 控制行的可见性                 |
| `xmax`     | 删除/更新事务号 | 行被删除或更新时的事务 ID，用于 MVCC 可见性判断                 |
| `cmin`     | 插入命令号      | 在事务中插入行的命令号                                          |
| `cmax`     | 删除/更新命令号 | 在事务中删除/更新行的命令号                                     |
| `tableoid` | 表 OID          | 该行所在表的对象 ID，常用于继承表查询时识别行来源表             |

```sql
-- 查看每行的物理位置
SELECT ctid, * FROM users;

-- 使用系统列删除重复行
DELETE FROM users a
USING users b
WHERE a.ctid < b.ctid
  AND a.email = b.email;

-- 查看行的创建事务号
SELECT xmin, id, name FROM users;
```

## 表修改

在 PostgreSQL 里，修改表主要通过 `ALTER TABLE` 来实现。它能做的事情很多，从增加/删除列到修改约束、索引，甚至表名都可以改。


| 操作              | 语法示例                                                                                                        |
| ----------------- | --------------------------------------------------------------------------------------------------------------- |
| 修改表名          | `ALTER TABLE old_name RENAME TO new_name;`                                                                      |
| 修改列名          | `ALTER TABLE users RENAME COLUMN username TO name;`                                                             |
| 添加列            | `ALTER TABLE users ADD COLUMN age INT;`                                                                         |
| 删除列            | `ALTER TABLE users DROP COLUMN age;`                                                                            |
| 修改列数据类型    | `ALTER TABLE users ALTER COLUMN age TYPE BIGINT;`                                                               |
| 设置默认值        | `ALTER TABLE users ALTER COLUMN status SET DEFAULT 'active';`                                                   |
| 删除默认值        | `ALTER TABLE users ALTER COLUMN status DROP DEFAULT;`                                                           |
| 设置/删除非空约束 | `ALTER TABLE users ALTER COLUMN email SET NOT NULL;` <br> `ALTER TABLE users ALTER COLUMN email DROP NOT NULL;` |
| 添加主键          | `ALTER TABLE users ADD PRIMARY KEY (id);`                                                                       |
| 添加唯一约束      | `ALTER TABLE users ADD CONSTRAINT uniq_email UNIQUE (email);`                                                   |
| 添加外键          | `ALTER TABLE orders ADD CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id);`                         |
| 删除约束          | `ALTER TABLE users DROP CONSTRAINT uniq_email;`                                                                 |
| 添加索引          | `CREATE INDEX idx_email ON users(email);`                                                                       |
| 修改表所有者      | `ALTER TABLE users OWNER TO new_owner;`                                                                         |

## 表继承

在 PostgreSQL 里，表是可以继承的，这一点和面向对象编程类似。它允许你定义一个父表，然后创建子表继承它的列和约束

**基本语法**

```sql
CREATE TABLE parent (
    id SERIAL PRIMARY KEY,
    name TEXT
);

CREATE TABLE child (
    extra_info TEXT
) INHERITS (parent);
```

* `child` 表会自动包含 `parent` 表的列：`id` 和 `name`
* 同时还可以增加自己的列 `extra_info`

**查询行为**

* 默认查询父表时，会包含子表的数据：
```sql
SELECT * FROM parent;
```

会返回 `parent` 和 `child` 中的记录。

* 如果只想查询父表本身数据，要加 `ONLY`：

```sql
SELECT * FROM ONLY parent;
```

**注意**
- CHECK 约束不会自动继承，需要在子表中单独定义
- 主键、唯一约束、外键也不会继承，要在子表里手动加
- 索引不会继承

[返回目录](/README.md)
