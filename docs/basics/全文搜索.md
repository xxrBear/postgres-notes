# 全文搜索

## 概念与背景

+ **全文搜索**：支持在大文本字段中高效查找单词或短语，并提供词形还原、语言感知和结果排序功能
+ **适用场景**：
  - 新闻、博客、论坛等内容检索
  - 商品描述搜索
  - 知识库、文档搜索
+ **PostgreSQL 内置功能**：无需外部插件即可使用全文搜索（但中文等语言仍需插件支持）

## 核心对象与术语

**文本搜索数据类型**

+ `tsvector`：文本的标准化表示形式，包含词元及其位置信息

```sql
SELECT to_tsvector('english', 'The quick brown fox jumped over the lazy dog');
-- 'brown':3 'dog':9 'fox':4 'jump':5 'lazi':8 'quick':2
```

+ `tsquery`：查询表达式，用于匹配 `tsvector`

```sql
SELECT to_tsquery('english', 'quick & fox');
-- 'quick' & 'fox'
```

+ **逻辑运算符**：`&`（与）、`|`（或）、`!`（非）
+ **短语搜索运算符**：`<->`（相邻）、`<N>`（间隔N个词）

**词典**

+ 用于词汇规范化处理
+ **常用内置词典**：
    - `simple`：按分隔符拆分文本，不进行词形还原
    - `english`：支持英语词干提取
    - `snowball`：支持多语言词干提取
    - `ispell`：词典结合拼写检查
    - `synonym`：同义词映射
+ 支持自定义词典

## 配置管理

+ **搜索配置** = 分词器 + 词典组合
+ 每种语言都有默认配置（如 `english`、`simple`、`chinese_t`）
+ **查看配置**：

```sql
\dF      -- 查看所有配置
\dFd     -- 查看词典列表
\dFp     -- 查看分词器列表
```

## 基本操作

**构建文本向量**

+ `to_tsvector(config, text)`
+ 自动执行小写转换、停用词过滤和词干提取

```sql
SELECT to_tsvector('english', 'PostgreSQL is a powerful, open source object-relational database system');
```

**构造查询条件**

+ `to_tsquery(config, querytext)`：标准查询构造
+ `plainto_tsquery(config, text)`：将输入文本自动转换为AND组合查询
+ `phraseto_tsquery(config, text)`：短语搜索查询
+ `websearch_to_tsquery(config, text)`：支持Google风格搜索语法（`"词语1 词语2" -排除词 OR 可选词`）

**匹配查询**

+ **匹配运算符**：`@@`

```sql
SELECT 'fat cats ate rats'::tsvector @@ 'cat & rat'::tsquery;
-- true
```

**结果排序与相关性评分**

+ `ts_rank` / `ts_rank_cd`：计算匹配相关性分数
+ 示例：

```sql
SELECT ts_rank_cd(to_tsvector('english', body), to_tsquery('english', 'postgres')) AS rank
FROM articles
ORDER BY rank DESC;
```

**搜索结果高亮**

+ `ts_headline(config, text, query, options)`：返回带高亮标记的文本片段

```sql
SELECT ts_headline('english', 'The quick brown fox', to_tsquery('fox'));
-- The quick brown <b>fox</b>
```

## 索引优化

**GIN 索引**

+ 最适合全文搜索场景，支持大多数查询操作

```sql
CREATE INDEX idx_post_body ON posts USING GIN (to_tsvector('english', body));
```

**GiST 索引**

+ 灵活性更高，但性能通常不如GIN
+ 适用于 `@@`、`@>` 等操作符

**表达式索引**

+ 必须与查询中使用的 `to_tsvector` 完全一致

```sql
CREATE INDEX idx_articles_body ON articles
USING GIN (to_tsvector('english', body));
```

## 高级功能

**多字段联合搜索**

+ 将多个字段合并为单个向量，并分配不同权重

```sql
to_tsvector('english', coalesce(title,''))    * 'A' ||
to_tsvector('english', coalesce(summary,''))  * 'B' ||
to_tsvector('english', coalesce(content,''))  * 'C'
```

**权重分配**

+ **权重等级**：`A`（最高）、`B`、`C`、`D`
+ 常用于提升标题匹配结果的排名

**同义词扩展**

+ 定义 `synonym` 词典：

```plain
postgres pgsql postgresql
cat kitty feline
```

+ 配置到搜索配置中，实现同义词搜索功能

## 实践技巧

**搜索建议实现**

+ 结合 trigram (`pg_trgm` 扩展) 实现模糊匹配与全文搜索结合

```sql
CREATE EXTENSION pg_trgm;
SELECT word FROM dictionary ORDER BY word <-> 'postg' LIMIT 5;
```

**增量索引更新**

+ 全文搜索索引不会自动更新 `to_tsvector` 结果，需要使用触发器：

```sql
CREATE TRIGGER tsvectorupdate BEFORE INSERT OR UPDATE
ON documents FOR EACH ROW EXECUTE FUNCTION
tsvector_update_trigger(tsv, 'pg_catalog.english', title, body);
```

**JSONB字段搜索**

+ 对JSONB字段也可进行全文搜索：

```sql
CREATE INDEX idx_doc_jsonb_gin ON docs USING GIN (to_tsvector('english', doc->>'content'));
```

## 常见问题与解决方案

**配置一致性**：索引和查询必须使用相同的 `config` 参数

**大小写处理**：`tsvector` 会自动转换为小写

**停用词过滤**：可能导致某些常见词无法搜索到（如 "is"、"the"）

**性能优化建议**：

+ 数据量较小时，顺序扫描+排序可能比索引查询更快
+ 批量数据导入时，可先禁用索引，导入完成后再重建索引

## 内部实现原理

**tsvector存储结构**

+ 以词典化的词元形式存储，每个词条记录出现位置
+ 内部保存 `(词条, 位置数组)` 的倒排索引信息
+ 相比普通 `LIKE '%xxx%'` 查询效率显著提升

**tsquery优化**

+ 逻辑运算符会被优化为布尔表达式树
+ 查询时使用倒排索引，避免全表扫描

**GIN/GiST索引原理**

+ **GIN**：倒排索引（词元 → 文档ID列表），适合"包含查询"
+ **GiST**：平衡树结构，适合范围查询和复杂操作符，灵活性高但性能稍弱
+ **RUM（扩展）**：在GIN基础上支持排序优化（如相关性评分与查询一次完成）

## 查询扩展语法

**tsquery操作符**

+ `&`（与）、`|`（或）、`!`（非）
+ `<->`（紧邻）、`<N>`（间隔N个词）
+ `:*`（前缀搜索）

```sql
SELECT to_tsquery('postgres:*');  -- 匹配 postgres, postgresql
```

**phraseto_tsquery 与 <-> 的区别**

+ `phraseto_tsquery('cat ate rat')` 等价于 `'cat' <-> 'ate' <-> 'rat'`
+ 语法更自然，支持类Google风格的短语搜索

**websearch_to_tsquery**

+ 模拟Google搜索语法：
  - `"精确短语"` 精确匹配短语
  - `-词语` 排除特定词语
  - `词语1 OR 词语2` 逻辑或查询

## 性能优化技巧

**并行查询**

+ `tsvector` 搜索支持PostgreSQL的并行执行计划，大表查询可显著提升性能
+ 确保 `parallel_setup_cost` / `parallel_tuple_cost` 参数设置合理

**索引合并**

+ 多字段搜索时，可将多个 `to_tsvector` 拼接，避免多索引扫描
+ 或为每个字段分别建立索引，利用位图索引扫描

**部分索引**

+ 只为需要的行建立索引：

```sql
CREATE INDEX idx_ft_active ON docs
USING GIN (to_tsvector('english', content))
WHERE is_active = true;
```

**统计信息优化**

+ 使用 `ANALYZE` 更新词频统计，帮助优化器选择最佳执行计划
+ 相关参数调整：
    - `default_statistics_target`
    - `pg_statistic`

## 权重与排序优化

**权重分配（A/B/C/D）**

+ 用于不同字段的优先级设置
+ 常见分配：标题 `A`，摘要 `B`，正文 `C`

**ts_rank vs ts_rank_cd**

+ `ts_rank`：基于词频和文档长度计算相关度
+ `ts_rank_cd`：降低重复词的权重，避免关键词堆砌的影响

**自定义排序函数**

+ 可使用 `log`、`sqrt` 等数学函数包装rank值，使结果更符合自然排序
+ 可结合业务维度（点击率、发布时间等）进行加权计算

## 与其他功能集成

**全文搜索 + JSONB**

+ JSONB字段提取 + 全文搜索：

```sql
to_tsvector('english', doc->>'body')
```

+ 适合半结构化文档搜索场景

**全文搜索 + trigram (pg_trgm)**

+ 先用trigram进行模糊匹配，再用全文搜索排序
+ 适合处理拼写错误的查询场景

## 开发实践经验

**高亮摘要优化**

+ `ts_headline` 生成结果可能过长，可通过设置 `MaxWords`、`MinWords`、`ShortWord`、`FragmentDelimiter` 参数控制

**搜索建议/自动补全**

+ `pg_trgm` 提供近似搜索功能
+ `rum` 索引支持更高效的前缀搜索

**冷热数据分离**

+ 热数据表使用GIN索引
+ 冷数据只进行顺序扫描（减少索引存储压力）

**触发器维护tsvector**

+ `tsvector_update_trigger` 适用于简单场景
+ 复杂场景（多语言、多字段）建议编写自定义触发器

[返回目录](/README.md)
