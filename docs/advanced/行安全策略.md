# 行安全策略

## 简介

行级安全策略是 PostgreSQL 9.5 引入的一种机制，允许你在表级别定义策略，控制每个用户能看到或者操作哪些行。

此功能也称为行级安全性。默认情况下，表没有策略，因此如果用户根据 SQL 权限系统对表具有访问权限，则表中的所有行都可用于查询或更新

当表上启用了行安全时，所有对表的正常访问都必须由行安全策略允许。表的所有者通常不受行安全策略的约束。如果表中不存在策略，则会使用默认的拒绝策略，这意味着没有行可见或可修改。适用于整个表的命令（如 TRUNCATE 和 REFERENCES）不受行安全策略的约束

## 策略类型

| 类型     | 关键字       | 条件字段               | 说明                                         |
| -------- | ------------ | ---------------------- | -------------------------------------------- |
| 查询策略 | `FOR SELECT` | `USING`                | 哪些行可以被查询                             |
| 更新策略 | `FOR UPDATE` | `USING` + `WITH CHECK` | 哪些行可以被更新，以及更新后是否仍然满足条件 |
| 插入策略 | `FOR INSERT` | `WITH CHECK`           | 哪些行可以被插入                             |
| 删除策略 | `FOR DELETE` | `USING`                | 哪些行可以被删除                             |

- 示例

```sql
CREATE POLICY update_own_orders
    ON orders
    FOR UPDATE
    USING (user_id = current_user)
    WITH CHECK (user_id = current_user);
```

USING：用户只能修改属于自己的行
WITH CHECK：修改后仍然必须属于自己

## 默认策略模式

PostgreSQL 的 RLS 有两种模式：

| 模式               | 命令                               | 说明                        |
| ------------------ | ---------------------------------- | --------------------------- |
| PERMISSIVE（默认） | `CREATE POLICY ...`                | 多个策略之间用 OR 逻辑合并  |
| RESTRICTIVE        | `CREATE POLICY ... AS RESTRICTIVE` | 多个策略之间用 AND 逻辑合并 |

也就是说：

- PERMISSIVE：只要满足一个策略 就能访问
- RESTRICTIVE：必须满足所有策略 才能访问

示例：
```sql
CREATE POLICY p1 ON orders FOR SELECT USING (user_id = current_user);
CREATE POLICY p2 ON orders FOR SELECT USING (amount > 0);
```

结果是 (user_id = current_user) OR (amount > 0)

如果第二条写成：
```sql
CREATE POLICY p2 AS RESTRICTIVE ...
```

则逻辑变为 user_id = current_user AND amount > 0

## 管理命令

| 命令                                             | 功能                              |
| ------------------------------------------------ | --------------------------------- |
| `ALTER TABLE ... ENABLE ROW LEVEL SECURITY`      | 启用 RLS                          |
| `ALTER TABLE ... FORCE ROW LEVEL SECURITY`       | 强制 RLS，即使表的 owner 也要受限 |
| `ALTER TABLE ... DISABLE ROW LEVEL SECURITY`     | 关闭 RLS                          |
| `CREATE POLICY` / `DROP POLICY` / `ALTER POLICY` | 管理策略                          |


## 生产上的示例

- 准备工作

```sql
-- Simple passwd-file based example
CREATE TABLE passwd (
  user_name             text UNIQUE NOT NULL,
  pwhash                text,
  uid                   int  PRIMARY KEY,
  gid                   int  NOT NULL,
  real_name             text NOT NULL,
  home_phone            text,
  extra_info            text,
  home_dir              text NOT NULL,
  shell                 text NOT NULL
);

CREATE ROLE admin;  -- Administrator
CREATE ROLE bob;    -- Normal user
CREATE ROLE alice;  -- Normal user

INSERT INTO passwd VALUES
  ('admin','xxx',0,0,'Admin','111-222-3333',null,'/root','/bin/dash');
INSERT INTO passwd VALUES
  ('bob','xxx',1,1,'Bob','123-456-7890',null,'/home/bob','/bin/zsh');
INSERT INTO passwd VALUES
  ('alice','xxx',2,1,'Alice','098-765-4321',null,'/home/alice','/bin/zsh');

-- Be sure to enable row-level security on the table
ALTER TABLE passwd ENABLE ROW LEVEL SECURITY;

-- Create policies
-- Administrator can see all rows and add any rows
CREATE POLICY admin_all ON passwd TO admin USING (true) WITH CHECK (true);

-- Normal users can view all rows
CREATE POLICY all_view ON passwd FOR SELECT USING (true);

-- Normal users can update their own records, but
-- limit which shells a normal user is allowed to set
CREATE POLICY user_mod ON passwd FOR UPDATE
  USING (current_user = user_name)
  WITH CHECK (
    current_user = user_name AND
    shell IN ('/bin/bash','/bin/sh','/bin/dash','/bin/zsh','/bin/tcsh')
  );

-- Allow admin all normal rights
GRANT SELECT, INSERT, UPDATE, DELETE ON passwd TO admin;

-- Users only get select access on public columns
GRANT SELECT
  (user_name, uid, gid, real_name, home_phone, extra_info, home_dir, shell)
  ON passwd TO public;

-- Allow users to update certain columns
GRANT UPDATE
  (pwhash, real_name, home_phone, extra_info, shell)
  ON passwd TO public;
```

- 测试

让我们测试一下相关的行安全策略生效了没有

```shell
mydb=# set role admin;
SET
mydb=> table passwd;
 user_name | pwhash | uid | gid | real_name |  home_phone  | extra_info |  home_dir   |   shell
-----------+--------+-----+-----+-----------+--------------+------------+-------------+-----------
 admin     | xxx    |   0 |   0 | Admin     | 111-222-3333 |            | /root       | /bin/dash
 bob       | xxx    |   1 |   1 | Bob       | 123-456-7890 |            | /home/bob   | /bin/zsh
 alice     | xxx    |   2 |   1 | Alice     | 098-765-4321 |            | /home/alice | /bin/zsh
(3 行记录)


mydb=>  set role alice;
SET
mydb=> table passwd;
错误:  对表 passwd 权限不够
mydb=> select user_name,real_name,home_phone,extra_info,home_dir,shell from passwd;
 user_name | real_name |  home_phone  | extra_info |  home_dir   |   shell
-----------+-----------+--------------+------------+-------------+-----------
 admin     | Admin     | 111-222-3333 |            | /root       | /bin/dash
 bob       | Bob       | 123-456-7890 |            | /home/bob   | /bin/zsh
 alice     | Alice     | 098-765-4321 |            | /home/alice | /bin/zsh
(3 行记录)


mydb=> update passwd set user_name = 'joe';
错误:  对表 passwd 权限不够
mydb=> update passwd set real_name = 'Alice Doe';
UPDATE 1
mydb=> update passwd set real_name = 'John Doe' where user_name = 'admin';
UPDATE 0
mydb=> update passwd set shell = '/bin/xx';
错误:  新行违背了表"passwd"的行级安全策略
mydb=> delete from passwd;
错误:  对表 passwd 权限不够
mydb=> insert into passwd (user_name) values ('xxx');
错误:  对表 passwd 权限不够
mydb=> update passwd set pwhash = 'abc';
UPDATE 1
```

[返回目录](/README.md)
