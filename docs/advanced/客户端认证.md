# 客户端认证

认证是数据库服务器建立客户端身份的过程，并由此确定是否允许客户端应用程序（或运行客户端应用程序的用户）以所请求的数据库用户名进行连接

PostgreSQL 提供了多种不同的客户端认证方法。用于认证特定客户端连接的方法可以根据（客户端）主机地址、数据库和用户进行选择

**配置文件**

`pg_hba.conf` 是 postgres 中非常关键的一个配置文件，全名叫做：

> postgres Host-Based Authentication Configuration File
>

它的作用是：

> 控制谁可以连接 postgres、从哪里连接、用什么方式连接

+ 查看所在配置文件目录

```sql
SHOW hba_file;
```

**作用简述**

| 功能点       | 说明                                          |
| ------------ | --------------------------------------------- |
| 认证方式控制 | 支持密码、GSSAPI、LDAP、证书等多种认证方式    |
| 访问来源限制 | 可以限制 IP 地址或网段是否能连接 postgres     |
| 用户限制     | 可以限制哪些 postgres 用户允许访问            |
| 数据库限制   | 可以限制某些用户只允许访问某些数据库          |
| 连接类型限制 | 支持本地（`local`）或远程（`host`）连接的区分 |


**配置语法结构**

```
# TYPE  DATABASE  USER  ADDRESS        METHOD
host    mydb      alice 192.168.1.0/24 md5
```

| 字段     | 说明                                                                  |
| -------- | --------------------------------------------------------------------- |
| TYPE     | `local`（Unix socket）、`host`（IPv4）、`hostssl`（SSL）、`hostnossl` |
| DATABASE | 可为具体库名、`all`、`replication` 等                                 |
| USER     | postgres 用户名，可为具体名或 `all`                                   |
| ADDRESS  | IP 地址范围，`127.0.0.1/32`、`0.0.0.0/0` 等                           |
| METHOD   | 认证方式，比如 `trust`、`md5`、`scram-sha-256`、`peer`、`reject`      |


**常见认证方式**

| 认证方式        | 说明                                                        |
| --------------- | ----------------------------------------------------------- |
| `trust`         | 不验证密码，不安全，仅适合本地测试用                        |
| `md5`           | 要求密码验证（老式加密，常用）                              |
| `scram-sha-256` | 更强密码验证机制（推荐用）                                  |
| `peer`          | 本地连接中使用操作系统用户名作为验证（仅 `local` 类型可用） |
| `reject`        | 拒绝连接（可用于精确禁止某些 IP）                           |

**如何只允许某个 IP 访问数据库**

假设你只想允许 IP `192.168.1.100` 连接数据库，可以这样配置：

```
# 只允许 192.168.1.100 访问所有数据库，所有用户，用 md5 密码认证
host    all     all     192.168.1.100/32    md5

# 拒绝所有其他 IP 访问
host    all     all     0.0.0.0/0           reject
```

**顺序很重要！**  

postgres 会从上到下逐行匹配，匹配到第一个满足条件的规则就执行。所以允许规则要写在前面，拒绝规则写在后面

[返回目录](/README.md)
