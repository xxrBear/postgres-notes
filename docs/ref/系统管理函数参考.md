# 系统管理函数参考

## 会话基本信息

| 函数 / 变量                              | 说明                                         |
| ---------------------------------------- | -------------------------------------------- |
| `current_database()`                     | 当前会话所在的数据库名                       |
| `current_schema()`                       | 当前搜索路径中的第一个 schema                |
| `current_schemas(include_implicit bool)` | 当前搜索路径中的所有 schema 列表             |
| `current_user`                           | 当前会话的执行用户（可能受 `SET ROLE` 影响） |
| `session_user`                           | 会话初始用户（不会随 `SET ROLE` 变化）       |
| `user`                                   | 与 `current_user` 等价                       |
| `pg_backend_pid()`                       | 当前会话的后端进程 PID                       |
| `inet_client_addr()`                     | 客户端 IP 地址                               |
| `inet_client_port()`                     | 客户端端口                                   |
| `inet_server_addr()`                     | 服务器 IP 地址                               |
| `inet_server_port()`                     | 服务器端口                                   |
| `application_name` *(GUC)*               | 当前连接设置的应用名                         |
| `session_authorization`                  | 当前会话的授权用户名                         |

## 会话事务信息

| 函数                             | 说明                       |
| -------------------------------- | -------------------------- |
| `txid_current()`                 | 当前事务 ID（数值）        |
| `txid_current_snapshot()`        | 当前事务快照（可见性信息） |
| `txid_snapshot_xmin('snapshot')` | 从快照取最小事务 ID        |
| `txid_snapshot_xmax('snapshot')` | 从快照取最大事务 ID        |
| `txid_snapshot_xip('snapshot')`  | 从快照取未提交事务列表     |

## 会话运行状态

这些通常配合系统视图 `pg_stat_activity` 使用，函数直接获取有限信息：

| 函数                                            | 说明                       |
| ----------------------------------------------- | -------------------------- |
| pg_stat_get_backend_pid(backend_id)             | 获取后台进程 PID           |
| pg_stat_get_backend_activity(backend_id)        | 获取后台进程正在执行的 SQL |
| pg_stat_get_backend_client_addr(backend_id)     | 获取客户端 IP              |
| pg_stat_get_backend_client_port(backend_id)     | 获取客户端端口             |
| pg_stat_get_backend_start(backend_id)           | 会话开始时间               |
| pg_stat_get_backend_xact_start(backend_id)      | 事务开始时间               |
| pg_stat_get_backend_wait_event(backend_id)      | 当前等待的事件类型         |
| pg_stat_get_backend_wait_event_type(backend_id) | 等待事件大类               |

> 这些 `pg_stat_get_backend_*` 函数大多是内部统计接口，实际用时更多人直接查

```sql
SELECT * FROM pg_stat_activity WHERE pid = pg_backend_pid();
```

## 会话配置函数

| 函数                                   | 说明                 |
| -------------------------------------- | -------------------- |
| current_setting('param')               | 获取当前会话参数值   |
| set_config('param', 'value', is_local) | 设置当前会话参数值   |
| pg_show_all_settings() *(>=17)*        | 列出所有当前会话设置 |

## 会话时间与生命周期

| 函数                            | 说明                           |
| ------------------------------- | ------------------------------ |
| clock_timestamp()               | 当前实际时间（调用时立即取值） |
| statement_timestamp()           | 当前 SQL 开始执行的时间        |
| transaction_timestamp() / now() | 当前事务开始的时间             |
| pg_postmaster_start_time()      | 数据库服务启动时间             |

## 访问权限查询函数

这些函数通常返回布尔值，用于判断当前用户或指定用户是否拥有对某个对象的权限

**数据库权限函数**

| 函数                                            | 说明                           |
| ----------------------------------------------- | ------------------------------ |
| has_database_privilege(dbname, privilege)       | 判断当前用户是否拥有数据库权限 |
| has_database_privilege(user, dbname, privilege) | 判断指定用户是否拥有数据库权限 |

- 可用权限
```sql
CREATE      -- 创建模式（schema）
CONNECT     -- 连接数据库
TEMP        -- 创建临时表
TEMPORARY   -- TEMP 的别名
```

**模式权限函数**

| 函数                                              | 说明                         |
| ------------------------------------------------- | ---------------------------- |
| has_schema_privilege(schemaname, privilege)       | 判断当前用户是否拥有模式权限 |
| has_schema_privilege(user, schemaname, privilege) | 判断指定用户是否拥有模式权限 |

- 可用权限
```sql
CREATE  -- 创建对象
USAGE   -- 使用 schema 中的对象
```

**表/视图/序列权限函数**

| 函数                                            | 说明                       |
| ----------------------------------------------- | -------------------------- |
| `has_table_privilege(relname, privilege)`       | 判断当前用户是否拥有表权限 |
| `has_table_privilege(user, relname, privilege)` | 判断指定用户是否拥有表权限 |

- 可用权限
```sql
SELECT
INSERT
UPDATE
DELETE
TRUNCATE
REFERENCES
TRIGGER
```

> 注意：这里的 `relname` 可以是表、视图、物化视图、序列、外部表等

**列权限函数**

| 函数                                                     | 说明                     |
| -------------------------------------------------------- | ------------------------ |
| `has_column_privilege(relname, column, privilege)`       | 判断当前用户是否有列权限 |
| `has_column_privilege(user, relname, column, privilege)` | 判断指定用户是否有列权限 |

- 可用权限
```sql
SELECT
INSERT
UPDATE
REFERENCES
```
**函数权限函数**

| 函数                                                | 说明                       |
| --------------------------------------------------- | -------------------------- |
| `has_function_privilege(funcname, privilege)`       | 判断当前用户是否有函数权限 |
| `has_function_privilege(user, funcname, privilege)` | 判断指定用户是否有函数权限 |

- 可用权限
```sql
EXECUTE
```

**语言权限函数**

| 函数                                                | 说明                       |
| --------------------------------------------------- | -------------------------- |
| `has_language_privilege(langname, privilege)`       | 判断当前用户是否有语言权限 |
| `has_language_privilege(user, langname, privilege)` | 判断指定用户是否有语言权限 |

- 可用权限
```sql
USAGE
```

**大型对象权限函数**

| 函数                                                     | 说明                   |
| -------------------------------------------------------- | ---------------------- |
| `has_foreign_data_wrapper_privilege(fdwname, privilege)` | 判断 FDW 权限          |
| `has_foreign_server_privilege(servername, privilege)`    | 判断外部服务器权限     |
| `has_foreign_table_privilege(relname, privilege)`        | 判断外部表权限         |
| `has_foreign_table_privilege(user, relname, privilege)`  | 判断指定用户外部表权限 |
| `has_largeobject_privilege(loid, privilege)`             | 判断大型对象权限       |

大型对象可用权限
- SELECT
- UPDATE
- INSERT
- DELETE
- READ
- WRITE

[返回目录](/README.md)