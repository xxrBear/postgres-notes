# 日志管理

## 简介

建议将数据库服务器的日志输出保存到指定位置，而不是直接丢弃到 `/dev/null`。日志对于排查问题和诊断异常非常重要。

> 服务器日志可能包含敏感信息，需要妥善保护，无论其存储方式、存储位置或传输目的地。例如，某些 DDL 语句可能包含明文密码或其他身份验证信息；在 ERROR 级别记录的语句可能暴露应用程序的 SQL 源码，甚至包含部分数据行。记录这些信息是日志功能的预期行为，因此不应视为泄露或错误。请确保日志仅对经过授权的人员可见。

日志输出往往很大，尤其是在高调试级别下，因此不宜无限期保存。需要轮换日志文件，以便定期启动新日志文件并删除旧文件。

如果仅将 `postgres` 的 stderr 重定向到文件，可以获得日志输出，但截断日志文件的唯一方法是停止并重启服务器。对于开发环境可能可行，但生产环境通常无法接受。

更好的方法是将服务器 stderr 输出发送到日志轮换程序。PostgreSQL 内置了日志轮换工具，可通过在 `postgresql.conf` 中将 `logging_collector` 设置为 `true` 启用。并支持以 CSV 格式生成机器可读日志。

如果系统中已经使用其他日志轮换程序，也可以结合使用。例如，Apache 发行版中包含的 `rotatelogs` 可与 PostgreSQL 配合，将服务器 stderr 通过管道传输到它：

```bash
pg_ctl start | rotatelogs /var/log/pgsql_log 86400
```

你还可以结合使用 PostgreSQL 内置日志收集器和 `logrotate`：日志收集器负责生成日志文件及其路径，`logrotate` 定期归档。启动日志轮换时，`logrotate` 通过 `postrotate` 脚本向服务器发送 **SIGHUP** 信号，使服务器切换到新的日志文件或重新打开现有文件。PostgreSQL 可使用 `pg_ctl` 配合 logrotate 实现此操作，具体取决于日志配置。

>[!Warning]
>在使用静态日志文件名时，如果达到最大打开文件数限制或发生文件表溢出，服务器可能无法重新打开日志文件。在这种情况下，日志消息会发送到旧日志文件，直到成功进行日志轮换。如果 logrotate 配置为压缩日志文件并删除它，服务器可能会丢失在此期间记录的消息。为了避免此问题，您可以配置日志收集器动态分配日志文件名，并使用 prerotate 脚本来忽略已打开的日志文件。

另一种生产级别的日志输出管理方法是将其发送到 syslog，然后让 syslog 处理文件轮换。要做到这一点，请在 postgresql.conf 中将配置参数 log_destination 设置为 syslog（仅记录到 syslog）。然后，您可以随时向 syslog 守护进程发送一个 SIGHUP 信号，以强制它开始写入新的日志文件。如果您想自动化日志轮换，可以配置 logrotate 程序与 syslog 的日志文件一起工作。

然而，在许多系统上，syslog 并不可靠，尤其是处理大型日志消息时；它可能会在您最需要它们的时候截断或丢弃消息。此外，在 Linux 上，syslog 会将每条消息刷新到磁盘，导致性能不佳。（您可以在 syslog 配置文件中的文件名开头使用“-”来禁用同步。）

请注意，上面描述的所有解决方案都负责在可配置的间隔开始新的日志文件，但它们不处理旧的、不再有用的日志文件的删除。您可能需要设置一个批处理作业来定期删除旧日志文件。另一种可能性是配置轮换程序，以便旧日志文件被循环覆盖。

此外，还有一些外部工具可增强日志管理和分析功能：

* **pgBadger**：用于复杂日志分析，生成可视化报告
* **check_postgres**：可检测日志中重要消息并生成 Nagios 警报，同时监控其他异常情况

## 日志机制
PostgreSQL 的日志由服务器端进程输出，主要记录：

- 启动、关闭信息
- 错误、警告、notice
- 慢查询、锁等待、连接信息
- 自定义 RAISE NOTICE/ERROR 输出
- 后台任务、检查点、WAL 等

日志输出位置和格式由配置文件 postgresql.conf 控制

## 查看日志相关配置
```sql
SHOW log_destination;         -- 日志输出位置（如 stderr, csvlog, syslog）
SHOW logging_collector;       -- 是否启用日志收集器（必须为 on 才会写入文件）
SHOW log_directory;           -- 日志目录（相对路径时，相对于数据目录）
SHOW log_filename;            -- 日志文件名模式
SHOW log_statement;           -- 控制哪些 SQL 语句会被记录到日志中(none,all,ddl,mod)
SHOW log_min_duration_statement; --  记录执行时间超过指定毫秒数的 SQL 语句到日志，通常用于慢查询分析
```

- 修改配置文件`postgresql.conf`

```conf
# 开启日志收集器
logging_collector = on

# 日志输出目录（相对路径在数据目录内）
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'

# 记录所有语句（仅调试用）
log_statement = 'all'

# 或只记录慢查询（单位毫秒）
log_min_duration_statement = 5000  # 超过5秒的SQL会被记录

# 时间戳格式
log_line_prefix = '%m [%p] %u@%d '  # 时间+进程号+用户@数据库

# 自动轮换日志文件
log_rotation_age = 1d
log_rotation_size = 10MB
```

[返回目录](/README.md)
