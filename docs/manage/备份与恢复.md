## 备份与恢复

### 简介
`postgres` 数据库应定期备份，以防止断电、网络中断等故障下导致的数据库崩溃

备份`postgres`数据主要有三种不同的方法：

- SQL转储
- 文件系统级别的备份
- 连续归档

每种方法都有其自身的优点和缺点

### SQL转储

PostgreSQL 提供了 pg_dump 工具，用于生成包含 SQL 命令的转储文件。将该文件重新导入数据库时，便可按转储时的状态完整地重建数据库。其基本用法如下：

```sql
pg_dump dbname > dumpfile
```

与其他 PostgreSQL 客户端应用一样，pg_dump 默认使用当前操作系统用户名作为数据库用户名。若需覆盖此设置，可通过 -U 参数或环境变量 PGUSER 指定。pg_dump 遵循常规的客户端认证规则。

pg_dump 生成的转储文件在内部是一致的，即它反映了启动时刻数据库的快照。在转储过程中，数据库仍可正常运行，除非执行需要独占锁的操作，比如大多数 ALTER TABLE 命令操作。

- 恢复转储

```sql
psql dbname < dumpfile
```

- 导出单个表

```bash
pg_dump -U postgres -t mytable mydb > mytable.sql
```

- 指定表名，可多次指定多个表：

```bash
pg_dump -U postgres -t table1 -t table2 mydb > tables.sql
```

- 导出带数据和结构

默认 `pg_dump` 会导出结构和数据，如果只想导出结构：

```bash
pg_dump -U postgres -s mydb > mydb_schema.sql
```

`-s` 或 `--schema-only`：只导出表结构、视图、索引、约束等

`-a` 或 `--data-only`：只导出数据，不导出结构

- 使用 `psql` 导入 SQL 转储

```bash
psql -U username -d dbname -f db_backup.sql
```

> 注意：导入时，数据库 `mydb` 必须已经存在，如果不存在，需要先创建：`CREATE DATABASE mydb;`

- 自定义格式导出并恢复

```bash
pg_dump -U postgres -Fc mydb > mydb.dump
pg_restore -U postgres -d mydb mydb.dump
```

`pg_dumpall` 是 PostgreSQL 提供的全实例导出工具，与 `pg_dump` 不同的是：

* `pg_dump` 只能导出单个数据库
* `pg_dumpall` 可以导出整个 PostgreSQL 实例下的所有数据库，以及全局对象（如角色、权限、表空间等）

- 导出整个 PostgreSQL 实例到 SQL 文件

```bash
pg_dumpall -U postgres > full_backup.sql
```

* `-U postgres`：指定超级用户
* `>`：重定向到文件
* `full_backup.sql`：输出文件，里面包含所有数据库和全局对象的 SQL

> 注意：生成的是文本 SQL 文件，导入时可以直接用 `psql` 恢复

- 仅导出角色和全局对象

```bash
pg_dumpall -g -U postgres > globals.sql
```

* `-g` 或 `--globals-only`：只导出角色、权限、表空间等全局对象，不导出数据库数据
* 适合先备份用户权限，再单独用 `pg_dump` 备份每个数据库

- 导入全量 SQL 文件

```bash
psql -U postgres -f full_backup.sql
```

* 会依次创建所有角色、数据库、表，并插入数据
* 适合整个`postgres`实例迁移或恢复

### 连续归档和时间点恢复

**连续归档**

PostgreSQL 始终在集群数据目录的 pg_wal/ 子目录中维护预写式日志（WAL），记录数据库数据文件的所有更改。WAL 的主要作用是保证崩溃恢复：系统故障后，可通过重放自上次检查点以来的日志条目，将数据库恢复到一致状态

基于 WAL，还可以采用第三种备份策略：将文件系统级备份与 WAL 归档结合使用。在恢复时，先还原文件系统备份，再重放 WAL 文件，即可将系统恢复到最新状态。尽管这种方法更复杂，但它具备显著优势

目标：
不仅备份数据库某一刻的快照，还持续保存之后产生的 WAL 文件，这样可以恢复到任意时间点

原理：

1. 数据库变更首先写入 WAL
2. 开启归档模式后，PostgreSQL 会在 WAL 文件写满或切换时，将它复制到指定的归档目录
3. 只要你有一次全量备份 + 从备份时刻开始的所有 WAL 文件，就可以恢复到那个时间段内的任意状态

配置方法：

修改：`postgresql.conf` 文件

```conf
archive_mode = on
archive_command = 'cp %p /path/to/archive/%f'
wal_level = replica
```

* `%p`：WAL 文件的完整路径
* `%f`：WAL 文件名

归档目录要能长期保存，否则恢复时会缺文件

**时间点恢复**

目标：
在有了全量备份 + WAL 归档的前提下，把数据库恢复到某个精确时间点（比如出错前一秒）

步骤：

1. 准备全量备份

   * 通常用 `pg_basebackup` 或文件级备份：

   ```bash
   pg_basebackup -U postgres -D /backup/base -Fp -Xs -P
   ```

2. 拷贝 WAL 归档

   * 确保备份开始到恢复时间点之间的所有 WAL 文件都在归档目录里

3. 恢复时设置恢复目标

* 在 `postgresql.conf` 或 `recovery.signal` 配置：

   ```conf
   restore_command = 'cp /path/to/archive/%f %p'
   recovery_target_time = '2025-08-15 14:30:00'
   ```

   或恢复到特定事务：

   ```conf
   recovery_target_xid = '123456'
   ```

   或恢复到某个 LSN：

   ```conf
   recovery_target_lsn = '0/1607B48'
   ```

4. 启动恢复

   * 停库，把数据目录换成备份目录
   * 创建 `recovery.signal` 文件
   * 启动数据库，PostgreSQL 会按 WAL 回放到目标时间

**关系和区别**

| 功能     | 连续归档                         | 时间点恢复                  |
| -------- | -------------------------------- | --------------------------- |
| 目的     | 持续保存 WAL 以备后续恢复        | 根据 WAL 回放恢复到任意时间 |
| 前提     | 需要开启 archive_mode 并保存归档 | 需要连续归档和一次全量备份  |
| 使用场景 | 灾备、长时间回溯                 | 误删、数据错误后回退        |

[返回目录](#目录)
