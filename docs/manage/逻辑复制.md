## 逻辑复制

### 什么是逻辑复制

逻辑复制是一种基于 SQL 语义级别的复制方式，它不同于物理复制, 基于 WAL 日志字节流的复制

* **物理复制**：整个数据库集群按字节流复制，要求主从版本一致、架构一致，通常是「一主多从」做读写分离或高可用。
* **逻辑复制**：基于表级别的数据变更（INSERT、UPDATE、DELETE）进行复制，可以选择只复制某些表的数据，甚至支持跨版本、跨平台复制。

逻辑复制使用的是发布和订阅模型

### 逻辑复制的核心概念

* **发布者**：
  在主库定义一个发布规则，声明哪些表的数据变化会被发布

  ```sql
  CREATE PUBLICATION mypub FOR TABLE users, orders;
  ```

* **订阅者**：
  在从库上定义一个订阅，指定订阅哪个发布，以及如何连接主库

  ```sql
  CREATE SUBSCRIPTION mysub
  CONNECTION 'host=192.168.1.10 dbname=mydb user=repuser password=secret port=5432'
  PUBLICATION mypub;
  ```

* **逻辑解码**：
  PostgreSQL 将 WAL 日志里的变更解码成 SQL 层面的变化（INSERT/UPDATE/DELETE），再传递给订阅端。

### 使用场景

* **跨版本升级**：比如从 PostgreSQL 12 升级到 16，可以用逻辑复制逐步迁移数据
* **部分表复制**：只复制某些业务相关表，不需要整个库
* **跨平台/跨架构**：主库和从库可以运行在不同操作系统、甚至不同 PostgreSQL 版本
* **数据同步到分析库**：业务库负责写，订阅库用来跑报表或 BI

### 配置步骤

假设：

* 主库：`192.168.1.10`
* 从库：`192.168.1.20`
* 数据库：`mydb`

- 1.主库配置

`postgresql.conf` 修改：

```conf
wal_level = logical
max_replication_slots = 10
max_wal_senders = 10
```

`pg_hba.conf` 添加允许复制用户访问：

```conf
host replication repuser 192.168.1.20/32 md5
host mydb      repuser 192.168.1.20/32 md5
```

重启 PostgreSQL。

创建用户：

```sql
CREATE ROLE repuser WITH LOGIN REPLICATION PASSWORD 'secret';
```

创建发布：

```sql
CREATE PUBLICATION mypub FOR TABLE users, orders;
```


- 2.从库配置

在订阅端执行：

```sql
CREATE SUBSCRIPTION mysub
CONNECTION 'host=192.168.1.10 port=5432 dbname=mydb user=repuser password=secret'
PUBLICATION mypub;
```

Postgres 会自动复制已有数据（除非指定 `WITH (copy_data = false)`），之后保持增量同步

### 常用操作

* **添加新表到发布**

  ```sql
  ALTER PUBLICATION mypub ADD TABLE products;
  ```
* **删除表**

  ```sql
  ALTER PUBLICATION mypub DROP TABLE orders;
  ```
* **删除订阅**

  ```sql
  DROP SUBSCRIPTION mysub;
  ```
* **查看复制状态**

  ```sql
  \dRp+   -- 查看 publication
  \dRs+   -- 查看 subscription
  ```


### 注意事项

* 主从必须使用相同的数据库编码 (UTF8/GBK 等)，否则可能出问题
* 表必须有主键或唯一约束，否则 UPDATE/DELETE 无法确定行
* 逻辑复制只支持DML (数据变更)，不支持 DDL（比如 ALTER TABLE 不会同步）
* 如果订阅端的表已有数据，要小心冲突
* 一般用于数据迁移、分库分表、异地容灾、读写分离

[返回目录](#目录)
