## 系统管理函数

这些函数是 DBA 级工具，用于数据库维护、会话管理、锁管理、WAL 控制、统计信息重置等


### 会话与连接管理

| 函数                        | 说明                                         |
| --------------------------- | -------------------------------------------- |
| `pg_cancel_backend(pid)`    | 取消指定 PID 的查询（但不终止会话）          |
| `pg_terminate_backend(pid)` | 终止指定 PID 的会话                          |
| `pg_reload_conf()`          | 重新加载配置文件（等价于 `pg_ctl reload`）   |
| `pg_rotate_logfile()`       | 滚动 PostgreSQL 日志文件                     |
| `pg_backend_pid()`          | 返回当前会话的 PID                           |
| `pg_current_logfile()`      | 返回当前日志文件路径（`csvlog`、`stderr`等） |
| `pg_stat_activity` (视图)   | 当前所有会话、状态、SQL                      |
| `pg_blocking_pids(pid)`     | 查看阻塞指定 PID 的会话                      |

### 数据库与表维护

| 函数                                               | 说明                          |
| -------------------------------------------------- | ----------------------------- |
| `pg_stat_reset()`                                  | 重置所有统计信息              |
| `pg_stat_reset_shared('bgwriter' \| 'wal' ...)`    | 重置共享统计信息              |
| `pg_stat_reset_single_table_counters(rel_oid)`     | 重置指定表的统计信息          |
| `pg_stat_reset_single_function_counters(func_oid)` | 重置指定函数的统计信息        |
| `pg_relation_size(relation)`                       | 表或索引的大小（不含 TOAST）  |
| `pg_total_relation_size(relation)`                 | 表的总大小（含 TOAST 和索引） |
| `pg_table_size(relation)`                          | 表大小（含 TOAST，不含索引）  |
| `pg_indexes_size(relation)`                        | 索引总大小                    |
| `pg_size_pretty(bigint)`                           | 字节数格式化为可读形式        |
| `pg_database_size(name)`                           | 数据库大小                    |
| `pg_tablespace_size(name)`                         | 表空间大小                    |

### 锁与事务管理

| 函数                                                            | 说明                           |
| --------------------------------------------------------------- | ------------------------------ |
| `pg_try_advisory_lock(key)` / `pg_advisory_lock(key)`           | 获取会话级建议锁               |
| `pg_try_advisory_xact_lock(key)` / `pg_advisory_xact_lock(key)` | 获取事务级建议锁               |
| `pg_advisory_unlock(key)` / `pg_advisory_unlock_all()`          | 释放建议锁                     |
| `pg_blocking_pids(pid)`                                         | 查看阻塞当前 PID 的会话        |
| `pg_is_in_recovery()`                                           | 是否处于恢复模式（备用节点）   |
| `pg_safe_snapshot_export()` *(PG 17+)*                          | 导出一个可安全使用的快照       |
| `txid_current()`                                                | 当前事务 ID                    |
| `txid_current_snapshot()`                                       | 当前快照                       |
| `txid_status(xid)`                                              | 事务状态（已提交/中止/进行中） |
| `pg_xact_commit_timestamp(xid)`                                 | 事务提交时间（需启用）         |

### WAL 与归档管理

| 函数                            | 说明                             |
| ------------------------------- | -------------------------------- |
| `pg_switch_wal()` *(PG 10+)*    | 立即切换 WAL 段                  |
| `pg_create_restore_point(name)` | 创建恢复点（用于 PITR）          |
| `pg_current_wal_lsn()`          | 当前 WAL LSN                     |
| `pg_last_wal_receive_lsn()`     | 上次接收到的 WAL LSN（备用节点） |
| `pg_last_wal_replay_lsn()`      | 上次回放的 WAL LSN（备用节点）   |
| `pg_current_wal_insert_lsn()`   | 当前 WAL 插入位置                |
| `pg_walfile_name(lsn)`          | 根据 LSN 获取 WAL 文件名         |
| `pg_walfile_name_offset(lsn)`   | 返回 WAL 文件名和文件内偏移量    |
| `pg_switch_xlog()` *(<=PG 9.6)* | 旧版本 WAL 切换函数              |


### 统计与性能监控

| 函数 / 视图                                        | 说明                       |
| -------------------------------------------------- | -------------------------- |
| `pg_stat_reset()`                                  | 重置统计信息               |
| `pg_stat_file(path, missing_ok)`                   | 获取服务器上文件的状态     |
| `pg_ls_dir(dirname, missing_ok, include_dot_dirs)` | 列出目录内容               |
| `pg_ls_waldir()`                                   | 列出 WAL 目录的文件        |
| `pg_ls_archive_statusdir()`                        | 列出 WAL 归档状态文件      |
| `pg_read_file(filename, offset, length)`           | 读取服务器文件内容         |
| `pg_read_binary_file(filename, offset, length)`    | 读取二进制文件             |
| `pg_read_file_v2(...)` *(PG 16+)*                  | 加强版文件读取             |
| `pg_stat_statements` *(扩展)*                      | SQL 执行统计（需启用扩展） |
| `pg_stat_io` *(PG 15+)*                            | I/O 统计                   |
| `pg_stat_all_tables` / `pg_stat_all_indexes`       | 表 & 索引访问统计          |
| `pg_statio_all_tables`                             | 表 I/O 命中率等            |


### 复制与备份

| 函数 / 视图                                              | 说明                       |
| -------------------------------------------------------- | -------------------------- |
| `pg_create_physical_replication_slot(name)`              | 创建物理复制槽             |
| `pg_create_logical_replication_slot(name, plugin)`       | 创建逻辑复制槽             |
| `pg_drop_replication_slot(name)`                         | 删除复制槽                 |
| `pg_replication_slot_advance(name, lsn)`                 | 推进复制槽位置             |
| `pg_replication_origin_create(name)`                     | 创建复制源                 |
| `pg_replication_origin_drop(name)`                       | 删除复制源                 |
| `pg_replication_origin_advance(name, lsn)`               | 推进复制源位置             |
| `pg_start_backup(label, fast)` / `pg_stop_backup()`      | 执行基于文件系统的备份     |
| `pg_backup_start_time()`                                 | 获取最后一次备份开始时间   |
| `pg_replication_slots` (视图)                            | 当前复制槽信息             |
| `pg_stat_replication` (视图)                             | 主节点查看从节点状态       |
| `pg_last_wal_receive_lsn()` / `pg_last_wal_replay_lsn()` | 备用节点 WAL 接收/回放位置 |


### 角色与权限管理

| 函数                                             | 说明                             |
| ------------------------------------------------ | -------------------------------- |
| `pg_has_role(role, privilege)`                   | 检查当前用户是否具有指定角色权限 |
| `pg_has_any_role(role)`                          | 检查当前用户是否属于某个角色     |
| `pg_has_table_privilege(user, table, privilege)` | 检查表权限                       |
| `pg_has_sequence_privilege(...)`                 | 检查序列权限                     |
| `pg_has_function_privilege(...)`                 | 检查函数权限                     |
| `pg_has_column_privilege(...)`                   | 检查列权限                       |

### 其他管理类函数

| 函数                                      | 说明                             |
| ----------------------------------------- | -------------------------------- |
| `pg_sleep(seconds)`                       | 让当前会话暂停指定秒数           |
| `pg_sleep_for(interval)`                  | 按时间间隔暂停                   |
| `pg_sleep_until(timestamp)`               | 暂停到某个时间点                 |
| `pg_promote(wait_seconds, check_seconds)` | 提升 standby 节点为主节点        |
| `pg_is_in_backup()`                       | 是否正在执行 `pg_start_backup()` |
| `pg_is_in_recovery()`                     | 是否处于恢复模式                 |
| `pg_backup_start_time()`                  | 最后一次备份开始时间             |

[返回目录](#目录)
